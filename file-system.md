Файловая структура проекта SLCF
=========

В корне проекта находятся 4 директории (assets, bundles, code, vendors).

В **assets** лежат исходные материалы для верстки, имеющие смысл в рамках всего проекта: техническая документация, гайдлайны, и т.д..

**code** – содержит конечные файлы верстки. В _code_ как минимум два раздела: _dev_ и _production_, содержащие одноименные версии файлов. Все файлы в _dev_ и _production_ добавляются автоматически и никогда руками. _Production_ содержит то же, что и _dev_, но после применения утилит для оптимизации, также могут быть изменены имена некоторых файлов и структура директорий для соответствия требованиям к выкладке проекта. Реальная работа по проекту ведется с _dev_-версией файлов, _production_-версия используется только для тестирования.

**bundles** — главная папка, содержит, как ни странно, бандлы. Бандл — коллекция деклараций блоков, страниц и всего, что относится к какой-либо конкретной части проекта. Бандлов в проекте может быть много — для разных разделов или отдельных страниц, или всего один — на весь проект сайта или приложения. Бандлы могут содержать зависимости от других **внешних** (из _vendors_) бандлов, составляя тем самым уровни переопределения для отдельных технологий. Бандлы могут отличаться по содержанию. По умолчанию в проекте один бандл — _main_.

**vendors** — содержит зависимости проекта – подключения внешних бандлов. Для подключения используется механизм git submodules.
_Vendors_ по умолчанию содержит:
- [SLCF Compiler](https://github.com/bivihoba/slcf-compiler) — инструмент, предназначенный для организации и написания HTML-страниц в БЭМ-терминах на BEMXML. Синтаксис BEMXML подробно описан ниже.
- [SLCF Docs](https://github.com/bivihoba/slcf-docs)
- [SLCF Nano Core](https://github.com/askaza/slcf-nano-core) – минимальный набор блоков, задекларированных в HTML, которые описывают структуру HTML-документа и базовые конструкции.

### Бандл

Рассмотрим в качестве примера структуру бандла  _main_.

В **assets** лежат исходные материалы, имеющие непосредственное отношение к бандлу, чаще всего это PSD-макеты, файлы спрайтов и т.п..

**Pages** содержит описания страниц в BEMXML.

**Page-schemes** содержит индексы БЭМ-сущностей для каждой из страниц (файлы генерируются при сборке страниц).

**Templates** содержит файлы с декларациями общих шаблонов (фрагменты BEMXML), которые можно использовать на страницах.

Декларации блоков складываются в отдельные папки по технологиям. Папки с декларациями именуются согласно схеме: название технологии + суффикс ".blocks". Так, _less.blocks_ — содержит декларации блоков в технологии Less, _html.blocks_ – в технологии HTML, и т.д. 

Содержание каталогов с декларациями различается в зависимости от технологий. Для HTML обычно используется один файл с декларациями – _default-semantic.xml_, а для стилей – поблочное разбиение на файлы.

Необязательно, чтобы каждой БЭМ-сущности соответствовал отдельный файл. Рекомендуется производить разбиение необходимости, исходя из задач проекта. 

В бандле _main_ также присутствуют _data-sources, utilities, i18nd_, но используются они не часто. Их предназначение соответственно порядку: xml-файлы с данными, xslt-шаблоны и DTD-файлы.

Важное значение имеют файлы в корне бандла. Самый главный файл – **settings.xml** — по сути хэлпер, который реализует уровни переопределения для BEMXML-шаблонов и HTML-семантики БЭМ-сущностей.

**styles.less** — объединяет все подключения стилей бандла. Аналогично для _Stylus_.

## Сборка стилей

Файлы стилей рекомендуется разбивать по БЭМ-сущностям, но поддерживать много файлов вручную неудобно, поэтому в SLCF заложен механизм для сборки стилей. Ключевыми элементами этого механизма являются вспомогательные файлы стилей и правильное именование файлов. Существует 4 технических файла с зарезервированными именами:

- blocks.auto.less
- blocks.auto.used.less
- blocks.deps.less
- blocks.hard.deps.less

_Это файлы для технологии Less, аналогичные имена будут для других стилевых технологий, поддерживаемых в SLCF (про поддержку технологий см. ниже)._

Файлы _blocks.auto.less_ и _blocks.auto.used.less_ генерируются автоматически, _blocks.deps.less_ и _blocks.hard.deps.less_ нужно создавать руками при необходимости. Каждый из этих файлов содержит список импортов.

_blocks.auto.less_ – включает все файлы БЭМ-сущностей бандла + те, что объявлены в _blocks.deps.less_.

_blocks.deps.less_ – содержит подключения зависимостей от внешних бандлов. Это могут быть точечные подключения конкретных БЭМ-сущностей или подключение бандлов как библиотек, в этом случае подключается файл blocks.auto.less внешнего бандла.

Пример:
```
@import "../../../vendors/slcf-nano-core/less.blocks/blocks.auto.less"; // все блоки бандла slcf-nano-core
@import "../../../vendors/slcf-ui-controls/less.blocks/b-select.less"; // один блок бандла slcf-ui-controls
```

Можно было бы ограничиться двумя этими файлами, но тогда из-за лишних деклараций в самом бандле и при подключении внешних библиотек, возникает проблема лишнего кода. Для ее устранения вводится дополнительный этап сборки - проверка на используемость БЭМ-сущностей на страницах бандла. Все подключения в _blocks.auto.less_ сравниваются с перечнем БЭМ-сущностей, которые составляют конечные BEMXML-деревья всех страниц бандла (индекс БЭМ-сущностей для каждой страницы можно найти в папке _page-schemes_ бандла).

В такой проверке есть один минус. При пересечении множества всех деклараций бандла и множества сущностей в BEMXML, из результирующего множества выпадают те сущности, которые в BEMXML не объявлены. Такие сущности могут появляются динамически как  результат выполнения Javascript, или находятся в шаблонах внутри CDATA-областей, или нужно подключить их независимо от текущего состояния страниц. Поскольку таких сущностей на данный момент несопоставимо меньше, чем тех, что составляют BEMXML, то придется вручную "возвращать" их в сборку. Для таких "жестких" зависимостей предназначен файл _blocks.hard.deps.less_.

Все подключения, прошедшие проверку на использование, вместе с объявленными в _blocks.hard.deps.less_, составляют _blocks.auto.used.less_.

В сборке важны еще два момента: 

1. Автоматически подключаются в _blocks.auto.less_ и проходят сравнение только правильно названные файлы.
2. Все импорты в _blocks.auto.less_ и _blocks.auto.used.less_ отсортированы в порядке приоритета БЭМ-модификаторов.

### Схема именования файлов деклараций

Для работы сборщика необходимо соблюдать правила именования файлов. В целом имя файла должно соответствовать классической БЭМ-нотации. Имя файла должен начинаться с префикса "b-" за которым следует полное название БЭМ-сущности (также как в BEMXML). Для деклараций модификаторов можно в имени файла опускать значение модификатора. 

Правильные имена файлов:

- b-page.less
- b-section__header.less
- b-button_size.less
- b-form-field_type_text.less

### Приоритеты БЭМ-модификаторов

Приоритет модификаторов задается в _specialBEMModes_ конфига /grunt/slcf-tools/config.js . Если модификатор не включен в конфиг, то он не обладает дополнительным приоритетом.

### Стилевые технологии

Описанная система сборки стилей применима для всех стилевых технологий, поддерживаемых в SLCF ( см. _CSS_technologies_ в конфиге /grunt/slcf-tools/config.js)
